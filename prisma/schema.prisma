generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============= CREATORS =============

model Creator {
  id           String   @id @default(cuid())
  slug         String   @unique
  name         String
  displayName  String
  avatar       String?
  cardImage    String?
  coverImage   String?
  bio          String?

  // Link to user account (creator owner) - one user can manage multiple creators
  userId       String?
  user         User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Social links (JSON string)
  socialLinks  String   @default("{}")

  // Theme customization (JSON string)
  theme        String   @default("{}")

  // Payment wallets
  walletEth    String?
  walletBtc    String?

  // Stats cache
  photoCount      Int   @default(0)
  videoCount      Int   @default(0)
  subscriberCount Int   @default(0)

  // Status
  isActive     Boolean  @default(true)
  sortOrder    Int      @default(0)

  // AI Girlfriend Mode
  aiEnabled        Boolean  @default(false)
  aiPersonality    String?  // JSON: name, age, traits, interests, style
  aiResponseDelay  Int      @default(120) // Average delay in seconds (2min default)
  aiLastActive     DateTime?

  // Earnings tracking
  pendingBalance   Float    @default(0)  // Balance awaiting payout
  totalEarned      Float    @default(0)  // Total earned (net after commission)
  totalPaid        Float    @default(0)  // Total paid out
  earnings         CreatorEarning[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ============= AI RESPONSE QUEUE =============

model AiResponseQueue {
  id             String   @id @default(cuid())
  messageId      String   @unique
  conversationId String
  creatorSlug    String
  scheduledAt    DateTime // When AI should respond
  status         String   @default("PENDING") // PENDING | PROCESSING | COMPLETED | FAILED
  response       String?  // Generated response
  mediaId        String?  // Media ID to attach as PPV
  attempts       Int      @default(0)
  maxAttempts    Int      @default(3)
  error          String?
  createdAt      DateTime @default(now())
  processedAt    DateTime?

  @@index([status, scheduledAt])
  @@index([creatorSlug])
}

// ============= AUTHENTICATION =============

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  passwordHash  String?
  name          String?
  image         String?
  role          String    @default("USER")

  // Creator account - can manage multiple creator profiles
  isCreator       Boolean   @default(false)
  creatorProfiles Creator[]

  // VIP status (manual grant by admin)
  isVip           Boolean   @default(false)

  // Credits system
  creditBalance   Int       @default(0)
  creditTransactions CreditTransaction[]

  // Stripe
  stripeCustomerId String?

  // Auth
  accounts      Account[]
  sessions      Session[]

  // Subscriptions & Purchases
  subscriptions     Subscription[]
  mediaPurchases    MediaPurchase[]
  messagePurchases  MessagePayment[]

  // Chat
  sentMessages      Message[]       @relation("sender")
  receivedMessages  Message[]       @relation("receiver")
  conversations     ConversationParticipant[]

  // Creator earnings (payments made by this user)
  creatorEarnings   CreatorEarning[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Role: "USER" | "ADMIN"

// ============= CREDITS SYSTEM =============

model CreditTransaction {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  amount         Int      // Positive = add, Negative = spend
  balance        Int      // Balance after transaction

  type           String   // "SUBSCRIPTION_GRANT" | "PURCHASE" | "MEDIA_UNLOCK" | "TIP" | "PPV" | "EXPIRATION" | "ADMIN_GRANT" | "RECURRING_GRANT"

  // Optional references
  mediaId        String?
  messageId      String?
  subscriptionId String?

  description    String?
  expiresAt      DateTime? // When these credits expire

  createdAt      DateTime @default(now())

  @@index([userId])
  @@index([type])
  @@index([expiresAt])
}

// CreditTransactionType: "SUBSCRIPTION_GRANT" | "PURCHASE" | "MEDIA_UNLOCK" | "TIP" | "PPV" | "EXPIRATION" | "ADMIN_GRANT" | "RECURRING_GRANT"

// ============= CREATOR EARNINGS =============

model CreatorEarning {
  id              String   @id @default(cuid())
  creatorSlug     String
  creator         Creator  @relation(fields: [creatorSlug], references: [slug], onDelete: Cascade)

  // Transaction source
  type            String   // "MEDIA_UNLOCK" | "TIP" | "PPV" | "SUBSCRIPTION"
  sourceId        String?  // mediaId, messageId, subscriptionId, etc.

  // Amounts (in EUR)
  grossAmount     Float    // Gross amount before commission
  commissionRate  Float    // 0.00 or 0.05 (5%)
  commissionAmount Float   // Platform commission taken
  netAmount       Float    // Net amount for creator

  // Status
  status          String   @default("PENDING")  // "PENDING" | "PAID"
  paidAt          DateTime?
  payoutTxId      String?  // Transaction ID when paid out

  // User who paid
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())

  @@index([creatorSlug])
  @@index([status])
  @@index([userId])
}

// CreatorEarningType: "MEDIA_UNLOCK" | "TIP" | "PPV" | "SUBSCRIPTION"
// CreatorEarningStatus: "PENDING" | "PAID"

// ============= SUBSCRIPTION PLANS =============

model SubscriptionPlan {
  id                 String   @id @default(cuid())
  name               String   @unique
  slug               String   @unique
  description        String?

  // Pricing
  monthlyPrice       Float
  annualPrice        Float
  currency           String   @default("USD")

  // Stripe
  stripeProductId    String?
  stripePriceMonthly String?
  stripePriceAnnual  String?

  // Access
  accessTier         String   // "FREE" | "BASIC" | "VIP"
  canMessage         Boolean  @default(false)
  downloadLimit      Int?

  // Credits (new system)
  initialCredits     Int      @default(0)     // Credits given at subscription start (Basic=1000, VIP=5000)
  recurringCredits   Int      @default(0)     // Credits given every interval (VIP=1000)
  creditIntervalDays Int      @default(6)     // Days between recurring credits

  // Features (JSON string)
  features           String   @default("[]")

  // Display
  isPopular          Boolean  @default(false)
  isActive           Boolean  @default(true)
  sortOrder          Int      @default(0)

  subscriptions      Subscription[]

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               String
  planId               String

  // Creator
  creatorSlug          String             @default("miacosta")

  // Status
  status               String             @default("PENDING") // "PENDING" | "TRIALING" | "ACTIVE" | "PAST_DUE" | "CANCELED" | "UNPAID" | "EXPIRED"

  // Payment
  paymentProvider      String             // "STRIPE" | "NOWPAYMENTS" | "MANUAL"
  stripeSubscriptionId String?            @unique
  stripeCustomerId     String?

  // Billing
  billingInterval      String             @default("MONTHLY") // "MONTHLY" | "ANNUAL"
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean            @default(false)
  canceledAt           DateTime?

  // Trial
  trialStart           DateTime?
  trialEnd             DateTime?

  // Credits tracking
  lastCreditGrant      DateTime?          // Last time recurring credits were granted
  nextCreditGrant      DateTime?          // Next scheduled credit grant

  metadata             String?

  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan                 SubscriptionPlan   @relation(fields: [planId], references: [id])

  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
}

// AccessTier: "FREE" | "BASIC" | "VIP"
// SubscriptionStatus: "PENDING" | "TRIALING" | "ACTIVE" | "PAST_DUE" | "CANCELED" | "UNPAID" | "EXPIRED"
// BillingInterval: "MONTHLY" | "ANNUAL"
// PaymentProvider: "STRIPE" | "NOWPAYMENTS" | "MANUAL"

// ============= CREATOR MEMBER MANAGEMENT =============

model CreatorMember {
  id           String   @id @default(cuid())
  creatorSlug  String
  userId       String

  // Permissions
  isVip        Boolean  @default(false)  // VIP granted by creator
  isBlocked    Boolean  @default(false)  // Blocked by creator

  // Notes (optional - for creator reference)
  notes        String?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([creatorSlug, userId])
  @@index([creatorSlug])
  @@index([userId])
}

// ============= MEDIA CONTENT =============

model MediaContent {
  id             String      @id @default(cuid())
  title          String
  slug           String      @unique
  description    String?

  // Creator
  creatorSlug    String      @default("miacosta")

  // Type
  type           String      // "PHOTO" | "VIDEO" | "AUDIO" | "PACK"

  // Access (legacy - keeping for backwards compatibility)
  accessTier     String      @default("FREE") // "FREE" | "BASIC" | "VIP"
  isPurchaseable Boolean     @default(false)
  price          Float?

  // Tags system (new)
  tagGallery     Boolean     @default(false)  // Show in public gallery
  tagPPV         Boolean     @default(false)  // Pay-per-view content
  tagAI          Boolean     @default(false)  // AI chatting can use this
  tagFree        Boolean     @default(false)  // Free for everyone (including visitors)
  tagVIP         Boolean     @default(false)  // VIP subscribers only
  ppvPriceCredits Int?                        // Price in credits if tagPPV (1000 = 1 media)

  // Files
  thumbnailUrl   String?
  previewUrl     String?
  contentUrl     String
  storageKey     String?

  // Metadata
  fileSize       Int?
  duration       Int?
  width          Int?
  height         Int?
  mimeType       String?

  // Organization
  categoryId     String?
  category       Category?   @relation(fields: [categoryId], references: [id])
  tags           String      @default("[]")

  // Stats
  viewCount      Int         @default(0)
  purchaseCount  Int         @default(0)

  // Status
  isPublished    Boolean     @default(false)
  isFeatured     Boolean     @default(false)
  showInGallery  Boolean     @default(true)  // If false, won't appear on homepage/gallery (legacy, use tagGallery)
  publishedAt    DateTime?

  // Relations
  purchases      MediaPurchase[]
  messageMedia   MessageMedia[]

  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@index([tagGallery])
  @@index([tagFree])
  @@index([tagVIP])
  @@index([tagAI])
}

model Category {
  id          String         @id @default(cuid())
  name        String         @unique
  slug        String         @unique
  description String?
  coverImage  String?
  sortOrder   Int            @default(0)
  isActive    Boolean        @default(true)

  media       MediaContent[]

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

// MediaType: "PHOTO" | "VIDEO" | "AUDIO" | "PACK"

// ============= MEDIA PURCHASES =============

model MediaPurchase {
  id            String        @id @default(cuid())
  userId        String
  mediaId       String

  // Payment
  amount        Float
  currency      String        @default("USD")
  provider      String        // "STRIPE" | "NOWPAYMENTS" | "MANUAL"
  providerTxId  String?
  status        String        @default("PENDING") // "PENDING" | "COMPLETED" | "FAILED" | "REFUNDED" | "CANCELLED"

  // Access
  expiresAt     DateTime?
  downloadCount Int           @default(0)
  maxDownloads  Int?

  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  media         MediaContent  @relation(fields: [mediaId], references: [id])

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@unique([userId, mediaId])
}

// PaymentStatus: "PENDING" | "COMPLETED" | "FAILED" | "REFUNDED" | "CANCELLED"

// ============= CHAT SYSTEM =============

model Conversation {
  id           String   @id @default(cuid())

  // Creator
  creatorSlug  String   @default("miacosta")

  participants ConversationParticipant[]
  messages     Message[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model ConversationParticipant {
  id             String       @id @default(cuid())
  conversationId String
  userId         String

  lastReadAt     DateTime?
  isTyping       Boolean      @default(false)

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  senderId       String
  receiverId     String

  // Content
  text           String?

  // Reply/Quote
  replyToId      String?
  replyTo        Message?     @relation("MessageReplies", fields: [replyToId], references: [id])
  replies        Message[]    @relation("MessageReplies")

  // PPV (Pay-Per-View)
  isPPV          Boolean      @default(false)
  ppvPrice       Float?
  ppvUnlockedBy  String       @default("[]")

  // Tips received
  totalTips      Float        @default(0)

  // Status
  isRead         Boolean      @default(false)
  isDeleted      Boolean      @default(false)

  // Relations
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation("sender", fields: [senderId], references: [id])
  receiver       User         @relation("receiver", fields: [receiverId], references: [id])
  media          MessageMedia[]
  payments       MessagePayment[]
  reactions      MessageReaction[]

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model MessageReaction {
  id        String   @id @default(cuid())
  messageId String
  userId    String
  emoji     String   // "‚ù§Ô∏è" | "üòÇ" | "üòÆ" | "üò¢" | "üëç" | "üëé"

  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([messageId, userId, emoji])
}

model MessageMedia {
  id         String        @id @default(cuid())
  messageId  String

  // Link to existing media or direct upload
  mediaId    String?

  // Direct upload
  type       String    // "PHOTO" | "VIDEO" | "AUDIO" | "PACK"
  url        String
  previewUrl String?

  message    Message       @relation(fields: [messageId], references: [id], onDelete: Cascade)
  media      MediaContent? @relation(fields: [mediaId], references: [id])

  createdAt  DateTime      @default(now())
}

model MessagePayment {
  id        String             @id @default(cuid())
  messageId String
  userId    String

  type      String             // "PPV_UNLOCK" | "TIP"
  amount    Float
  currency  String             @default("USD")

  provider  String             // "STRIPE" | "NOWPAYMENTS" | "MANUAL"
  providerTxId String?
  status    String             @default("PENDING") // "PENDING" | "COMPLETED" | "FAILED" | "REFUNDED" | "CANCELLED"

  message   Message            @relation(fields: [messageId], references: [id])
  user      User               @relation(fields: [userId], references: [id])

  createdAt DateTime           @default(now())
}

// MessagePaymentType: "PPV_UNLOCK" | "TIP"

// ============= GENERAL PAYMENTS =============

model Payment {
  id           String        @id @default(cuid())
  userId       String

  // Creator
  creatorSlug  String        @default("miacosta")

  amount       Float
  currency     String        @default("USD")

  // Platform fee (3%)
  platformFee  Float         @default(0)
  netAmount    Float         @default(0)

  provider     String        // "STRIPE" | "NOWPAYMENTS" | "MANUAL"
  providerTxId String?

  status       String        @default("PENDING") // "PENDING" | "COMPLETED" | "FAILED" | "REFUNDED" | "CANCELLED"

  type         String        // "SUBSCRIPTION" | "MEDIA_PURCHASE" | "PPV_UNLOCK" | "TIP"
  description  String?

  metadata     String?

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

// PaymentType: "SUBSCRIPTION" | "MEDIA_PURCHASE" | "PPV_UNLOCK" | "TIP"

// ============= ANALYTICS =============

model PageView {
  id          String   @id @default(cuid())

  // Page info
  path        String
  referrer    String?

  // Visitor info
  visitorId   String   // Anonymous visitor ID (from cookie)
  userId      String?  // Logged in user ID (optional)

  // Device/Browser info
  userAgent   String?
  device      String?  // "desktop" | "mobile" | "tablet"
  browser     String?
  os          String?
  country     String?

  // Session
  sessionId   String

  createdAt   DateTime @default(now())

  @@index([path])
  @@index([visitorId])
  @@index([createdAt])
  @@index([sessionId])
}

model DailyStats {
  id            String   @id @default(cuid())
  date          DateTime @unique

  // Visits
  totalViews    Int      @default(0)
  uniqueVisitors Int     @default(0)

  // Top pages (JSON)
  topPages      String   @default("[]")

  // Sources
  topReferrers  String   @default("[]")

  // Devices
  deviceStats   String   @default("{}")

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ============= SITE SETTINGS =============

model SiteSettings {
  id              String   @id @default(cuid())
  creatorSlug     String?  @unique

  // Site settings
  siteName        String?
  siteDescription String?
  siteUrl         String?
  welcomeMessage  String?
  welcomeMediaId  String?  // ID of MediaContent to send with welcome message
  welcomeMediaUrl String?  // Direct URL if uploaded separately

  // Branding
  logo            String?
  favicon         String?
  primaryColor    String?
  accentColor     String?

  // Pricing (stored as JSON string)
  pricing         String   @default("{}")

  // Payment toggles
  stripeEnabled   Boolean  @default(true)
  cryptoEnabled   Boolean  @default(false)

  // Features toggles
  chatEnabled     Boolean  @default(true)
  tipsEnabled     Boolean  @default(true)
  ppvEnabled      Boolean  @default(true)

  // System toggles
  maintenanceMode      Boolean  @default(false)
  registrationEnabled  Boolean  @default(true)
  emailNotifications   Boolean  @default(true)
  pushNotifications    Boolean  @default(false)

  // Platform commission settings
  platformWalletEth        String?
  platformWalletBtc        String?
  platformCommission       Float    @default(0.05)  // 5% default
  firstMonthFreeCommission Boolean  @default(true)  // 0% first month

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ============= ACCOUNTING QUEUE =============

model AccountingQueue {
  id          String   @id @default(cuid())

  // Payload data (JSON)
  payload     String

  // Status
  status      String   @default("PENDING") // "PENDING" | "PROCESSING" | "COMPLETED" | "FAILED"

  // Retry info
  attempts    Int      @default(0)
  maxAttempts Int      @default(5)
  lastError   String?
  nextRetryAt DateTime?

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  processedAt DateTime?

  @@index([status])
  @@index([nextRetryAt])
}
