generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============= AGENCY =============

model Agency {
  id   String @id @default(cuid())
  name String
  slug String @unique

  // Owner (user who created the agency)
  ownerId String
  owner   User   @relation("AgencyOwner", fields: [ownerId], references: [id])

  // Public profile (for Find Agency)
  logo          String?
  website       String?
  description   String? @db.Text
  publicVisible Boolean @default(false) // Show in Find Agency (must fill profile first)

  // Extended public profile
  tagline         String? // Short tagline
  services        String? @db.Text // JSON array: ["Management", "Chatting", "Marketing"]
  specialties     String? @db.Text // JSON array of content categories
  minRevenueShare Int? // Min revenue share offered to creators
  maxRevenueShare Int? // Max revenue share offered to creators
  socialLinks     String? @db.Text // JSON: {instagram, twitter, tiktok}
  portfolioImages String? @db.Text // JSON array of image URLs
  location        String? // Country/Region
  languages       String? @db.Text // JSON array: ["English", "French"]
  yearsInBusiness Int?

  // Settings (controlled by Admin)
  platformFee Float   @default(0.10) // 10% platform commission

  // AI Provider Settings (agency-wide defaults)
  aiProvider     String  @default("anthropic") // anthropic | openai | openrouter
  aiModel        String  @default("claude-haiku-4-5-20241022")
  aiApiKey       String? // Encrypted custom API key (null = use platform key)
  aiApiKeyHash   String? // Masked key for display (sk-ant-****1234)
  aiUseCustomKey Boolean @default(false)

  // Status
  status String @default("ACTIVE") // ACTIVE | SUSPENDED | BANNED

  // Relations
  creators        Creator[]
  chatters        Chatter[]
  aiPersonalities CreatorAiPersonality[]
  scripts         Script[]
  scriptFolders   ScriptFolder[]
  scriptSequences ScriptSequence[]
  applications    AgencyApplication[]
  listing         AgencyListing?
  earnings        AgencyEarning[]

  // Payout requests
  payoutRequests        AgencyPayoutRequest[]
  creatorPayouts        AgencyCreatorPayout[]

  // Balance tracking
  pendingBalance Float @default(0) // Balance awaiting payout
  totalEarned    Float @default(0) // Total earned (net after chatter commission)
  totalPaid      Float @default(0) // Total paid out

  // Payment wallets for agency payouts
  walletEth String?
  walletBtc String?

  // Stats cache
  totalRevenue  Float @default(0)
  averageRating Float @default(0)
  reviewCount   Int   @default(0)

  // Public stats for Find Agency
  publicStats AgencyPublicStats?

  // Listing visibility
  isListed        Boolean @default(false) // Show in Find Agency
  listingPriority Int     @default(0) // Higher = more visible

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// AgencyStatus: "ACTIVE" | "SUSPENDED" | "BANNED"

// ============= CHATTER (human employee) =============

model Chatter {
  id String @id @default(cuid())

  // Auth
  email        String  @unique
  passwordHash String
  name         String
  avatar       String?

  // Agency
  agencyId String
  agency   Agency @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  // Assigned creators (many-to-many)
  assignedCreators ChatterCreatorAssignment[]

  // Commission
  commissionEnabled Boolean @default(false)
  commissionRate    Float   @default(0.10) // 10% by default

  // Balance tracking
  pendingBalance Float @default(0) // Balance awaiting payout
  totalPaid      Float @default(0) // Total paid out

  // Payment wallets for chatter payouts
  walletEth String?
  walletBtc String?

  // Stats
  totalEarnings        Float @default(0)
  totalMessages        Int   @default(0)
  totalSales           Int   @default(0)
  messagesOutsideShift Int   @default(0) // Messages sent outside scheduled shift

  // Status
  isActive     Boolean   @default(true)
  lastActiveAt DateTime?

  // Schedule - JSON: { "monday": [{"start": "09:00", "end": "17:00"}], ... }
  schedule String? // JSON string for work schedule

  // Attributed earnings
  earnings ChatterEarning[]

  // Payout requests
  payoutRequests ChatterPayoutRequest[]

  // Messages sent by this chatter
  messages Message[] @relation("ChatterMessages")

  // Conversations assigned to this chatter
  assignedConversations Conversation[] @relation("AssignedConversations")

  // AI Suggestions sent by this chatter
  sentSuggestions AiSuggestion[] @relation("SentBySuggestions")

  // Scripts
  scriptUsages    ScriptUsage[]
  scriptFavorites ChatterScriptFavorite[]

  // AI Copilot preferences - JSON: {panelLayout, defaultTone, shortcuts}
  preferences       String?
  lastAnalyticsView DateTime?

  // Sessions for analytics
  sessions ChatterSession[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([agencyId])
}

model ChatterCreatorAssignment {
  id          String @id @default(cuid())
  chatterId   String
  creatorSlug String

  chatter Chatter @relation(fields: [chatterId], references: [id], onDelete: Cascade)
  creator Creator @relation(fields: [creatorSlug], references: [slug], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([chatterId, creatorSlug])
  @@index([creatorSlug])
}

// Chatter work session for analytics
model ChatterSession {
  id             String    @id @default(cuid())
  chatterId      String
  conversationId String?
  creatorSlug    String?

  // Session timing
  startedAt DateTime  @default(now())
  endedAt   DateTime?

  // Session stats
  messagesCount       Int   @default(0)
  scriptsUsed         Int   @default(0)
  aiSuggestionsUsed   Int   @default(0)
  aiSuggestionsCharged Int  @default(0)
  revenue             Float @default(0)

  // Relations
  chatter Chatter @relation(fields: [chatterId], references: [id], onDelete: Cascade)

  @@index([chatterId])
  @@index([startedAt])
  @@index([creatorSlug])
}

// ============= AI PERSONALITY =============
// Can belong to either an Agency OR directly to a Creator

model CreatorAiPersonality {
  id   String @id @default(cuid())
  name String // "Sweet", "Dominant", etc.

  // Agency (optional - for agency-managed creators)
  agencyId String?
  agency   Agency? @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  // Creator (optional - for independent creators without agency)
  creatorId String?
  creator   Creator? @relation("CreatorAiPersonalities", fields: [creatorId], references: [id], onDelete: Cascade)

  // Creator slug (always required - identifies which creator profile this is for)
  creatorSlug String

  // Personality config
  personality String // JSON: traits, style, tone, etc.

  // Language targeting (for language-based routing)
  language String? // "en", "es", "fr", "de", "it", "pt", "zh", "ja", "ko", "ar", "ru", "hi" or null for any language

  // Tone matching (for auto-switching)
  primaryTone  String? // "romantic", "playful", "explicit", "casual", "demanding"
  toneKeywords String? // JSON array of keywords that trigger this personality

  // A/B Testing
  trafficShare Int     @default(100) // % of traffic (0-100)
  isActive     Boolean @default(true)

  // Media Settings for this AI personality
  aiMediaEnabled   Boolean @default(true) // AI can send media in conversations
  aiMediaFrequency Int     @default(4) // Send media every X messages on average
  aiPPVRatio       Int     @default(30) // % of media that are PPV (0-100)
  aiTeasingEnabled Boolean @default(true) // AI can tease about PPV before sending

  // Handoff Settings (switch to human chatter)
  autoHandoffEnabled    Boolean @default(true) // Auto handoff when threshold reached
  handoffSpendThreshold Float   @default(40) // Spending threshold in EUR (default $40)
  handoffOnHighIntent   Boolean @default(true) // Handoff on purchase signals
  handoffKeywords       String? // JSON array of keywords triggering handoff

  // Give-up Settings (stop AI for non-paying fans)
  giveUpOnNonPaying       Boolean @default(false) // Stop AI after X messages with 0 spend
  giveUpMessageThreshold  Int     @default(20) // Message count threshold before giving up
  giveUpAction            String  @default("stop") // "stop" = no response, "minimal" = rare short responses

  // Stats
  totalEarnings  Float @default(0)
  totalMessages  Int   @default(0)
  totalSales     Int   @default(0)
  conversionRate Float @default(0)

  // Attributed earnings
  earnings AiPersonalityEarning[]

  // Messages sent by this AI personality
  messages Message[] @relation("AiPersonalityMessages")

  // Conversation assignments
  conversations Conversation[]
  switchesFrom  PersonalitySwitch[] @relation("SwitchFrom")
  switchesTo    PersonalitySwitch[] @relation("SwitchTo")

  // AI Suggestions generated by this personality
  aiSuggestions AiSuggestion[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([creatorSlug])
  @@index([agencyId])
  @@index([primaryTone])
}

// ============= PERSONALITY SWITCH TRACKING =============

model PersonalitySwitch {
  id String @id @default(cuid())

  // Conversation
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // From/To personalities
  fromPersonalityId String?
  fromPersonality   CreatorAiPersonality? @relation("SwitchFrom", fields: [fromPersonalityId], references: [id], onDelete: SetNull)

  toPersonalityId String
  toPersonality   CreatorAiPersonality @relation("SwitchTo", fields: [toPersonalityId], references: [id], onDelete: Cascade)

  // Switch reason
  reason       String // "auto_tone", "manual", "initial_assignment"
  detectedTone String? // Tone that triggered the switch (if auto)
  triggeredBy  String? // userId if manual switch

  createdAt DateTime @default(now())

  @@index([conversationId])
  @@index([toPersonalityId])
  @@index([reason])
  @@index([createdAt])
}

// ============= SCRIPTS LIBRARY =============

model Script {
  id String @id @default(cuid())

  // Owner - the creator who owns this script
  creatorSlug String
  creator     Creator @relation("CreatorScripts", fields: [creatorSlug], references: [slug], onDelete: Cascade)

  // Agency (optional - for filtering imports from same agency)
  agencyId String?
  agency   Agency? @relation(fields: [agencyId], references: [id], onDelete: SetNull)

  // Import tracking
  importedFrom     String? // creatorSlug of the original script owner
  importedFromName String? // Display name for UI

  // Script content
  name     String // "Sexy intro", "PPV pitch", etc.
  content  String @db.Text // The script text
  category String // "GREETING" | "PPV_PITCH" | "FOLLOW_UP" | "CLOSING" | "CUSTOM"

  // Folder organization
  folderId String?
  folder   ScriptFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)

  // Author (who created this script)
  authorId String?
  author   User?   @relation("ScriptAuthor", fields: [authorId], references: [id], onDelete: SetNull)

  // Workflow validation
  status          String    @default("APPROVED") // DRAFT | PENDING | APPROVED | REJECTED
  approvedById    String?
  approvedBy      User?     @relation("ScriptApprover", fields: [approvedById], references: [id], onDelete: SetNull)
  approvedAt      DateTime?
  rejectionReason String?

  // Template variables
  hasVariables Boolean @default(false)
  variables    String? // JSON array: ["fanName", "price", "creatorName", etc.]

  // === TRIGGER / CONTEXT ===
  intent          String?             // "GREETING", "OBJECTION_PRICE", "PPV_PITCH", etc.
  triggerKeywords String?             // JSON: ["trop cher", "expensive", "prix"]
  triggerPatterns String?             // JSON: regex patterns for matching
  fanStage        String?             // "new", "engaged", "vip", "cooling_off", "any"
  minConfidence   Float   @default(0.5) // Threshold for auto-match (0-1)
  priority        Int     @default(50)  // 1-100, higher = more priority

  // === PRICING (for PPV scripts) ===
  suggestedPrice Float?              // Suggested PPV price
  priceMin       Float?              // Minimum acceptable price
  priceMax       Float?              // Maximum price
  isFreeTease    Boolean @default(false) // Send for free to hook them

  // === AI INTEGRATION ===
  aiInstructions   String?  @db.Text  // Instructions for AI on how to use/modify
  allowAiModify    Boolean  @default(true) // AI can adapt the script
  preserveCore     String?             // Part that must be kept intact
  exampleResponses String?             // JSON: acceptable variations
  successScore     Float    @default(0) // Auto-calculated success score

  // === FLOW / BRANCHING ===
  nextScriptOnSuccess String?          // Script ID to use if positive response
  nextScriptOnReject  String?          // Script ID to use if negative response
  followUpDelay       Int?             // Minutes before follow-up
  followUpScriptId    String?          // Script ID for follow-up

  // === LANGUAGE ===
  language String @default("any")      // "fr", "en", "es", or "any"

  // === OBJECTION HANDLING ===
  objectionType     String?            // "price", "time", "trust", "not_interested"
  objectionResponse String? @db.Text   // Specific response for this objection

  // Media attachments
  mediaItems ScriptMedia[]

  // Sequence (for sequential scripts) - DEPRECATED, use flow fields instead
  sequenceId    String?
  sequence      ScriptSequence? @relation(fields: [sequenceId], references: [id], onDelete: SetNull)
  sequenceOrder Int? // Position in sequence

  // Stats (calculated automatically)
  usageCount       Int    @default(0)
  messagesSent     Int    @default(0)
  salesGenerated   Int    @default(0)
  revenueGenerated Float  @default(0)
  conversionRate   Float  @default(0) // Calculated: salesGenerated / messagesSent * 100
  avgResponseTime  Float? // Average time before fan response (seconds)

  // Metadata
  isActive   Boolean @default(true)
  isFavorite Boolean @default(false) // Owner's favorite

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  messages         Message[]
  usageLogs        ScriptUsage[]
  chatterFavorites ChatterScriptFavorite[]

  @@index([agencyId])
  @@index([creatorSlug])
  @@index([folderId])
  @@index([status])
  @@index([sequenceId])
  @@index([intent])
  @@index([fanStage])
  @@index([language])
}

// ScriptCategory: "GREETING" | "PPV_PITCH" | "FOLLOW_UP" | "CLOSING" | "CUSTOM"
// ScriptStatus: "DRAFT" | "PENDING" | "APPROVED" | "REJECTED"

// ============= SCRIPT FOLDERS =============

model ScriptFolder {
  id String @id @default(cuid())

  // Owner - the creator who owns this folder
  creatorSlug String
  creator     Creator @relation("CreatorScriptFolders", fields: [creatorSlug], references: [slug], onDelete: Cascade)

  // Agency (optional - for filtering)
  agencyId String?
  agency   Agency? @relation(fields: [agencyId], references: [id], onDelete: SetNull)

  // Folder info
  name        String
  description String?
  color       String? // Hex color for the folder
  icon        String? // Emoji or icon name

  // Hierarchy (sub-folders)
  parentId String?
  parent   ScriptFolder?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children ScriptFolder[] @relation("FolderHierarchy")

  // Scripts in this folder
  scripts Script[]

  // Display order
  order Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([agencyId])
  @@index([parentId])
}

// ============= SCRIPT MEDIA (attachments) =============

model ScriptMedia {
  id String @id @default(cuid())

  // Script
  scriptId String
  script   Script @relation(fields: [scriptId], references: [id], onDelete: Cascade)

  // Media content
  mediaId String
  media   MediaContent @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  // Display order
  order Int @default(0)

  createdAt DateTime @default(now())

  @@index([scriptId])
  @@index([mediaId])
}

// ============= SCRIPT SEQUENCES (conversation flows) =============

model ScriptSequence {
  id String @id @default(cuid())

  // Agency
  agencyId String
  agency   Agency @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  // Sequence info
  name        String
  description String?
  category    String // PPV_FUNNEL | ONBOARDING | REACTIVATION | CUSTOM

  // Scripts in this sequence (ordered by sequenceOrder)
  scripts Script[]

  // Status
  isActive Boolean @default(true)

  // Stats
  timesStarted   Int   @default(0)
  timesCompleted Int   @default(0)
  totalRevenue   Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([agencyId])
  @@index([category])
}

// SequenceCategory: "PPV_FUNNEL" | "ONBOARDING" | "REACTIVATION" | "CUSTOM"

// ============= SCRIPT USAGE LOGS =============

model ScriptUsage {
  id String @id @default(cuid())

  // Script used
  scriptId String
  script   Script @relation(fields: [scriptId], references: [id], onDelete: Cascade)

  // Who used it
  chatterId String
  chatter   Chatter @relation(fields: [chatterId], references: [id], onDelete: Cascade)

  // Context
  conversationId String
  messageId      String? // Message created with this script
  creatorSlug    String
  fanUserId      String

  // Action taken
  action        String // COPIED | SENT | SENT_MODIFIED | CANCELLED
  modifications String? @db.Text // What was modified

  // Sale attribution
  resultedInSale Boolean @default(false)
  saleAmount     Float?
  saleType       String? // PPV | TIP | SUBSCRIPTION

  // Timing
  usedAt       DateTime @default(now())
  responseTime Int? // Seconds before fan response

  @@index([scriptId])
  @@index([chatterId])
  @@index([conversationId])
  @@index([usedAt])
  @@index([resultedInSale])
}

// ScriptUsageAction: "COPIED" | "SENT" | "SENT_MODIFIED" | "CANCELLED"

// ============= CHATTER SCRIPT FAVORITES =============

model ChatterScriptFavorite {
  id String @id @default(cuid())

  // Chatter
  chatterId String
  chatter   Chatter @relation(fields: [chatterId], references: [id], onDelete: Cascade)

  // Script
  scriptId String
  script   Script @relation(fields: [scriptId], references: [id], onDelete: Cascade)

  // Display order
  order Int @default(0)

  createdAt DateTime @default(now())

  @@unique([chatterId, scriptId])
  @@index([chatterId])
}

// ============= EARNINGS ATTRIBUTION =============

model AgencyEarning {
  id String @id @default(cuid())

  agencyId String
  agency   Agency @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  // Original earning reference
  creatorEarningId String
  creatorEarning   CreatorEarning @relation(fields: [creatorEarningId], references: [id], onDelete: Cascade)

  // Amounts (in EUR)
  grossAmount   Float // Gross amount (after platform commission)
  agencyShare   Float // % agency keeps (e.g., 0.30 = 30%)
  agencyGross   Float // Agency gross before chatter commission
  chatterAmount Float @default(0) // What chatter earns (deducted from agency)
  netAmount     Float // Net for agency (after chatter commission)

  // Type
  type String // "PPV" | "TIP" | "MEDIA_UNLOCK" | "SUBSCRIPTION"

  // Status
  status String    @default("PENDING") // "PENDING" | "PAID"
  paidAt DateTime?

  createdAt DateTime @default(now())

  @@index([agencyId])
  @@index([creatorEarningId])
  @@index([status])
}

model ChatterEarning {
  id String @id @default(cuid())

  chatterId String
  chatter   Chatter @relation(fields: [chatterId], references: [id], onDelete: Cascade)

  // Original earning reference
  creatorEarningId String
  creatorEarning   CreatorEarning @relation(fields: [creatorEarningId], references: [id], onDelete: Cascade)

  // Amounts
  grossAmount      Float // Sale amount (agency gross)
  commissionRate   Float // % chatter commission
  commissionAmount Float // What chatter earns

  // Attribution info
  attributedMessageId String? // Message that triggered the sale
  delayedAttribution  Boolean @default(false) // If > 1h after message

  // Type
  type String // "PPV" | "TIP" | "MEDIA_UNLOCK"

  // Status
  status String    @default("PENDING") // "PENDING" | "PAID"
  paidAt DateTime?

  createdAt DateTime @default(now())

  @@index([chatterId])
  @@index([creatorEarningId])
  @@index([status])
}

model AiPersonalityEarning {
  id String @id @default(cuid())

  aiPersonalityId String
  aiPersonality   CreatorAiPersonality @relation(fields: [aiPersonalityId], references: [id], onDelete: Cascade)

  // Original earning reference
  creatorEarningId String
  creatorEarning   CreatorEarning @relation(fields: [creatorEarningId], references: [id], onDelete: Cascade)

  // Amounts
  grossAmount Float

  // Attribution info
  attributedMessageId String?

  // Type
  type String // "PPV" | "TIP" | "MEDIA_UNLOCK"

  createdAt DateTime @default(now())

  @@index([aiPersonalityId])
  @@index([creatorEarningId])
}

// ============= CREATORS =============

model Creator {
  id          String  @id @default(cuid())
  slug        String  @unique
  name        String
  displayName String
  avatar      String?
  cardImage   String?
  coverImage  String?
  bio         String?

  // Link to user account (creator owner) - one user can manage multiple creators
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Agency (optional - a creator can be managed by an agency)
  agencyId String?
  agency   Agency? @relation(fields: [agencyId], references: [id], onDelete: SetNull)

  // Agency Takeover (when external creator joins agency)
  isAgencyManaged Boolean   @default(false) // True when creator is managed by agency with restricted access
  agencyManagedAt DateTime?                 // When agency takeover started
  originalOwnerId String?                   // Original user ID before takeover (for audit)

  // Social links (JSON string)
  socialLinks String @default("{}")

  // Theme customization (JSON string)
  theme String @default("{}")

  // Payment wallets
  walletEth String?
  walletBtc String?

  // Stats cache
  photoCount      Int @default(0)
  videoCount      Int @default(0)
  subscriberCount Int @default(0)

  // Status
  isActive   Boolean @default(true)
  isFeatured Boolean @default(false) // Show on homepage
  sortOrder  Int     @default(0)

  // Category tags (JSON array of strings)
  categories String @default("[]")

  // AI Girlfriend Mode
  aiPersonality   String? // JSON: name, age, traits, interests, style
  aiResponseDelay Int       @default(120) // Average delay in seconds (2min default)
  aiLastActive    DateTime?

  // AI Media Sending Settings
  aiMediaEnabled   Boolean @default(true) // AI can send media in conversations
  aiMediaFrequency Int     @default(4) // Send media every X messages on average
  aiPPVRatio       Int     @default(30) // % of media that are PPV (0-100)
  aiTeasingEnabled Boolean @default(true) // AI can tease before sending PPV

  // AI Provider Settings
  aiProvider     String  @default("anthropic") // anthropic | openai | openrouter
  aiModel        String  @default("claude-haiku-4-5-20241022")
  aiApiKey       String? // Encrypted custom API key (null = use platform key)
  aiApiKeyHash   String? // Masked key for display (sk-ant-****1234)
  aiUseCustomKey Boolean @default(false)

  // Earnings tracking
  pendingBalance Float            @default(0) // Balance awaiting payout
  totalEarned    Float            @default(0) // Total earned (net after commission)
  totalPaid      Float            @default(0) // Total paid out
  earnings       CreatorEarning[]

  // Payout requests
  payoutRequests PayoutRequest[]

  // ID document for payout verification
  idDocument   String?   // Path to uploaded ID document
  idDocumentAt DateTime? // Upload date

  // Model listing for Find Agency marketplace
  modelListing ModelListing?

  // AI Personalities for this creator
  aiPersonalities CreatorAiPersonality[] @relation("CreatorAiPersonalities")

  // Scripts library
  scripts       Script[]       @relation("CreatorScripts")
  scriptFolders ScriptFolder[] @relation("CreatorScriptFolders")

  // Chatters assigned to this creator
  assignedChatters ChatterCreatorAssignment[]

  // Conversations
  conversations Conversation[]

  // Public stats for Find Model
  publicStats CreatorPublicStats?

  // Listing visibility
  isListed         Boolean @default(false) // Show in Find Model
  lookingForAgency Boolean @default(false) // Actively looking for agency

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([agencyId])
  @@index([isListed])
  @@index([lookingForAgency])
}

// ============= AI RESPONSE QUEUE =============

model AiResponseQueue {
  id             String    @id @default(cuid())
  messageId      String    @unique
  conversationId String
  creatorSlug    String
  scheduledAt    DateTime // When AI should respond
  status         String    @default("PENDING") // PENDING | PROCESSING | COMPLETED | FAILED
  response       String? // Generated response
  mediaId        String? // Media ID to attach as PPV
  attempts       Int       @default(0)
  maxAttempts    Int       @default(3)
  error          String?
  createdAt      DateTime  @default(now())
  processedAt    DateTime?

  // AI Media Decision
  shouldSendMedia Boolean @default(false) // AI decided to send media
  mediaDecision   String? // "FREE" | "PPV" | "TEASE"
  teaseText       String? // Teaser text if teasing

  @@index([status, scheduledAt])
  @@index([creatorSlug])
}

// ============= AUTHENTICATION =============

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  passwordHash  String?
  name          String?
  image         String?
  role          String    @default("USER")

  // Creator account - can manage multiple creator profiles
  isCreator       Boolean   @default(false)
  creatorProfiles Creator[]

  // Agency ownership
  isAgencyOwner Boolean  @default(false)
  ownedAgencies Agency[] @relation("AgencyOwner")

  // Credits system
  creditBalance      Int                 @default(0) // Total (paid + bonus) for display
  paidCredits        Int                 @default(0) // Paid credits - usable everywhere
  bonusCredits       Int                 @default(0) // Bonus credits - PPV catalog only
  creditTransactions CreditTransaction[]

  // Stripe
  stripeCustomerId String?

  // Auth
  accounts Account[]
  sessions Session[]

  // Subscriptions & Purchases
  subscriptions    Subscription[]
  mediaPurchases   MediaPurchase[]
  messagePurchases MessagePayment[]

  // Chat
  sentMessages     Message[]                 @relation("sender")
  receivedMessages Message[]                 @relation("receiver")
  conversations    ConversationParticipant[]

  // Creator earnings (payments made by this user)
  creatorEarnings CreatorEarning[]

  // Scripts (author and approver)
  authoredScripts Script[] @relation("ScriptAuthor")
  approvedScripts Script[] @relation("ScriptApprover")

  // Creator applications (become a creator)
  creatorApplications CreatorApplication[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Role: "USER" | "ADMIN"

// ============= CREDITS SYSTEM =============

model CreditTransaction {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  amount  Int // Positive = add, Negative = spend
  balance Int // Balance after transaction

  type       String // "SUBSCRIPTION_GRANT" | "PURCHASE" | "MEDIA_UNLOCK" | "TIP" | "PPV" | "EXPIRATION" | "ADMIN_GRANT" | "RECURRING_GRANT"
  creditType String @default("PAID") // "PAID" | "BONUS"

  // Optional references
  mediaId        String?
  messageId      String?
  subscriptionId String?

  description String?
  expiresAt   DateTime? // When these credits expire

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([type])
  @@index([expiresAt])
}

// CreditTransactionType: "SUBSCRIPTION_GRANT" | "PURCHASE" | "MEDIA_UNLOCK" | "TIP" | "PPV" | "EXPIRATION" | "ADMIN_GRANT" | "RECURRING_GRANT"

// ============= CREATOR EARNINGS =============

model CreatorEarning {
  id          String  @id @default(cuid())
  creatorSlug String
  creator     Creator @relation(fields: [creatorSlug], references: [slug], onDelete: Cascade)

  // Transaction source
  type     String // "MEDIA_UNLOCK" | "TIP" | "PPV" | "SUBSCRIPTION"
  sourceId String? // mediaId, messageId, subscriptionId, etc.

  // Amounts (in EUR)
  grossAmount      Float // Gross amount before commission
  commissionRate   Float // 0.00 or 0.05 (5%)
  commissionAmount Float // Platform commission taken
  netAmount        Float // Net amount for creator

  // Status
  status     String    @default("PENDING") // "PENDING" | "PAID"
  paidAt     DateTime?
  payoutTxId String? // Transaction ID when paid out

  // User who paid
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Attribution (who generated this sale)
  chatterId           String? // Human chatter who made the sale
  aiPersonalityId     String? // AI personality who made the sale
  attributedMessageId String? // The message that triggered the sale

  // Attribution earnings
  agencyEarnings        AgencyEarning[]
  chatterEarnings       ChatterEarning[]
  aiPersonalityEarnings AiPersonalityEarning[]

  createdAt DateTime @default(now())

  @@index([creatorSlug])
  @@index([status])
  @@index([userId])
  @@index([chatterId])
  @@index([aiPersonalityId])
}

// CreatorEarningType: "MEDIA_UNLOCK" | "TIP" | "PPV" | "SUBSCRIPTION"
// CreatorEarningStatus: "PENDING" | "PAID"

// ============= SUBSCRIPTION PLANS =============

model SubscriptionPlan {
  id          String  @id @default(cuid())
  name        String  @unique
  slug        String  @unique
  description String?

  // Pricing
  monthlyPrice Float
  annualPrice  Float
  currency     String @default("USD")

  // Stripe
  stripeProductId    String?
  stripePriceMonthly String?
  stripePriceAnnual  String?

  // Access
  accessTier    String // "FREE" | "BASIC" | "VIP"
  canMessage    Boolean @default(false)
  downloadLimit Int?

  // Credits (new system)
  initialCredits     Int @default(0) // Credits given at subscription start (Basic=1000, VIP=5000)
  recurringCredits   Int @default(0) // Credits given every interval (VIP=1000)
  creditIntervalDays Int @default(6) // Days between recurring credits

  // Features (JSON string)
  features String @default("[]")

  // Display
  isPopular Boolean @default(false)
  isActive  Boolean @default(true)
  sortOrder Int     @default(0)

  subscriptions Subscription[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Subscription {
  id     String @id @default(cuid())
  userId String
  planId String

  // Creator
  creatorSlug String @default("miacosta")

  // Status
  status String @default("PENDING") // "PENDING" | "TRIALING" | "ACTIVE" | "PAST_DUE" | "CANCELED" | "UNPAID" | "EXPIRED"

  // Payment
  paymentProvider      String // "STRIPE" | "NOWPAYMENTS" | "MANUAL"
  stripeSubscriptionId String? @unique
  stripeCustomerId     String?

  // Billing
  billingInterval    String    @default("MONTHLY") // "MONTHLY" | "ANNUAL"
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean   @default(false)
  canceledAt         DateTime?

  // Trial
  trialStart DateTime?
  trialEnd   DateTime?

  // Credits tracking
  lastCreditGrant DateTime? // Last time recurring credits were granted
  nextCreditGrant DateTime? // Next scheduled credit grant

  metadata String?

  user User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan SubscriptionPlan @relation(fields: [planId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// AccessTier: "FREE" | "BASIC" | "VIP"
// SubscriptionStatus: "PENDING" | "TRIALING" | "ACTIVE" | "PAST_DUE" | "CANCELED" | "UNPAID" | "EXPIRED"
// BillingInterval: "MONTHLY" | "ANNUAL"
// PaymentProvider: "STRIPE" | "NOWPAYMENTS" | "MANUAL"

// ============= CREATOR MEMBER MANAGEMENT =============

model CreatorMember {
  id          String @id @default(cuid())
  creatorSlug String
  userId      String

  // Permissions
  isVip     Boolean @default(false) // VIP granted by creator
  isBlocked Boolean @default(false) // Blocked by creator

  // Notes (optional - for creator reference)
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([creatorSlug, userId])
  @@index([creatorSlug])
  @@index([userId])
}

// ============= MEDIA CONTENT =============

model MediaContent {
  id          String  @id @default(cuid())
  title       String
  slug        String  @unique
  description String?

  // Creator
  creatorSlug String @default("miacosta")

  // Type
  type String // "PHOTO" | "VIDEO" | "AUDIO" | "PACK"

  // Access (legacy - keeping for backwards compatibility)
  accessTier     String  @default("FREE") // "FREE" | "BASIC" | "VIP"
  isPurchaseable Boolean @default(false)
  price          Float?

  // Tags system (new)
  tagGallery      Boolean @default(false) // Show in public gallery
  tagPPV          Boolean @default(false) // Pay-per-view content
  tagAI           Boolean @default(false) // AI chatting can use this
  tagFree         Boolean @default(false) // Free for everyone (including visitors)
  tagVIP          Boolean @default(false) // VIP subscribers only
  ppvPriceCredits Int? // Price in credits if tagPPV (1000 = 1 media)

  // Files
  thumbnailUrl String?
  previewUrl   String?
  contentUrl   String
  storageKey   String?

  // Metadata
  fileSize Int?
  duration Int?
  width    Int?
  height   Int?
  mimeType String?

  // Organization
  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id])
  tags       String    @default("[]")

  // Stats
  viewCount     Int @default(0)
  purchaseCount Int @default(0)

  // Status
  isFeatured    Boolean   @default(false)

  // Relations
  purchases    MediaPurchase[]
  messageMedia MessageMedia[]
  scriptMedia  ScriptMedia[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tagGallery])
  @@index([tagFree])
  @@index([tagVIP])
  @@index([tagAI])
}

model Category {
  id          String  @id @default(cuid())
  name        String  @unique
  slug        String  @unique
  description String?
  coverImage  String?
  sortOrder   Int     @default(0)
  isActive    Boolean @default(true)

  media MediaContent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// MediaType: "PHOTO" | "VIDEO" | "AUDIO" | "PACK"

// ============= MEDIA PURCHASES =============

model MediaPurchase {
  id      String @id @default(cuid())
  userId  String
  mediaId String

  // Payment
  amount       Float
  currency     String  @default("USD")
  provider     String // "STRIPE" | "NOWPAYMENTS" | "MANUAL"
  providerTxId String?
  status       String  @default("PENDING") // "PENDING" | "COMPLETED" | "FAILED" | "REFUNDED" | "CANCELLED"

  // Access
  expiresAt     DateTime?
  downloadCount Int       @default(0)
  maxDownloads  Int?

  user  User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  media MediaContent @relation(fields: [mediaId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, mediaId])
}

// PaymentStatus: "PENDING" | "COMPLETED" | "FAILED" | "REFUNDED" | "CANCELLED"

// ============= CHAT SYSTEM =============

model Conversation {
  id String @id @default(cuid())

  // Creator
  creatorSlug String  @default("miacosta")
  creator     Creator @relation(fields: [creatorSlug], references: [slug])

  // AI Personality Assignment (per-conversation)
  aiPersonalityId String?
  aiPersonality   CreatorAiPersonality? @relation(fields: [aiPersonalityId], references: [id], onDelete: SetNull)

  // Tone tracking for adaptive switching
  detectedTone   String? // "romantic", "playful", "explicit", "casual", "demanding"
  toneConfidence Float? // 0-1 confidence score
  lastToneCheck  DateTime?
  autoToneSwitch Boolean   @default(true) // Auto-switch enabled by default

  // AI Mode (for AI assisted workflow)
  aiMode String @default("auto") // "auto" | "assisted" | "disabled"

  // Chatter assignment (for handoff)
  assignedChatterId String?
  assignedChatter   Chatter? @relation("AssignedConversations", fields: [assignedChatterId], references: [id], onDelete: SetNull)

  // Script Flow Tracking
  lastScriptId          String?   // Last script sent to fan
  lastScriptSentAt      DateTime? // When the last script was sent
  awaitingFanResponse   Boolean   @default(false) // Waiting for fan to respond to script
  pendingFollowUpId     String?   // Follow-up script to send
  followUpDueAt         DateTime? // When to send the follow-up
  followUpSent          Boolean   @default(false) // Has the follow-up been sent

  // Relations
  participants        ConversationParticipant[]
  messages            Message[]
  personalitySwitches PersonalitySwitch[]
  aiSuggestions       AiSuggestion[]
  handoffs            ConversationHandoff[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([aiPersonalityId])
  @@index([assignedChatterId])
  @@index([aiMode])
  @@index([followUpDueAt])
  @@index([awaitingFanResponse])
}

model ConversationParticipant {
  id             String @id @default(cuid())
  conversationId String
  userId         String

  lastReadAt DateTime?
  isTyping   Boolean   @default(false)
  isPinned   Boolean   @default(false)
  isMuted    Boolean   @default(false)

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
}

model Message {
  id             String @id @default(cuid())
  conversationId String
  senderId       String
  receiverId     String

  // Content
  text String?

  // Reply/Quote
  replyToId String?
  replyTo   Message?  @relation("MessageReplies", fields: [replyToId], references: [id])
  replies   Message[] @relation("MessageReplies")

  // PPV (Pay-Per-View)
  isPPV         Boolean @default(false)
  ppvPrice      Float?
  ppvUnlockedBy String  @default("[]")

  // Tips received
  totalTips Float @default(0)

  // Status
  isRead    Boolean @default(false)
  isDeleted Boolean @default(false)

  // AI Generated flag (for UI badges)
  isAiGenerated Boolean @default(false)

  // Attribution (who sent this message on behalf of creator)
  chatterId       String? // If sent by a human chatter
  chatter         Chatter?             @relation("ChatterMessages", fields: [chatterId], references: [id], onDelete: SetNull)
  aiPersonalityId String? // If sent by an AI personality
  aiPersonality   CreatorAiPersonality? @relation("AiPersonalityMessages", fields: [aiPersonalityId], references: [id], onDelete: SetNull)

  // Script attribution
  scriptId       String? // If a script was used
  script         Script? @relation(fields: [scriptId], references: [id], onDelete: SetNull)
  scriptModified Boolean @default(false) // True if chatter modified the script

  // Sale result tracking
  resultedInSale Boolean @default(false)
  saleAmount     Float?

  // Performance tracking
  responseTimeSeconds Int?     // Time to respond to previous fan message
  fanEngagedAfter     Boolean? // Did fan respond within 24h?

  // Relations
  conversation Conversation      @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User              @relation("sender", fields: [senderId], references: [id])
  receiver     User              @relation("receiver", fields: [receiverId], references: [id])
  media        MessageMedia[]
  payments     MessagePayment[]
  reactions    MessageReaction[]
  aiSuggestion AiSuggestion? // Link to AI suggestion if this was from a suggestion

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([chatterId])
  @@index([aiPersonalityId])
  @@index([isAiGenerated])
}

model MessageReaction {
  id        String @id @default(cuid())
  messageId String
  userId    String
  emoji     String // "‚ù§Ô∏è" | "üòÇ" | "üòÆ" | "üò¢" | "üëç" | "üëé"

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([messageId, userId, emoji])
}

model MessageMedia {
  id        String @id @default(cuid())
  messageId String

  // Link to existing media or direct upload
  mediaId String?

  // Direct upload
  type       String // "PHOTO" | "VIDEO" | "AUDIO" | "PACK"
  url        String
  previewUrl String?

  message Message       @relation(fields: [messageId], references: [id], onDelete: Cascade)
  media   MediaContent? @relation(fields: [mediaId], references: [id])

  createdAt DateTime @default(now())
}

model MessagePayment {
  id        String @id @default(cuid())
  messageId String
  userId    String

  type     String // "PPV_UNLOCK" | "TIP"
  amount   Float
  currency String @default("USD")

  provider     String // "STRIPE" | "NOWPAYMENTS" | "MANUAL"
  providerTxId String?
  status       String  @default("PENDING") // "PENDING" | "COMPLETED" | "FAILED" | "REFUNDED" | "CANCELLED"

  message Message @relation(fields: [messageId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
}

// MessagePaymentType: "PPV_UNLOCK" | "TIP"

// ============= GENERAL PAYMENTS =============

model Payment {
  id     String @id @default(cuid())
  userId String

  // Creator
  creatorSlug String @default("miacosta")

  amount   Float
  currency String @default("USD")

  // Platform fee (3%)
  platformFee Float @default(0)
  netAmount   Float @default(0)

  provider     String // "STRIPE" | "NOWPAYMENTS" | "MANUAL"
  providerTxId String?

  status String @default("PENDING") // "PENDING" | "COMPLETED" | "FAILED" | "REFUNDED" | "CANCELLED"

  type        String // "SUBSCRIPTION" | "MEDIA_PURCHASE" | "PPV_UNLOCK" | "TIP"
  description String?

  metadata String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// PaymentType: "SUBSCRIPTION" | "MEDIA_PURCHASE" | "PPV_UNLOCK" | "TIP"

// ============= PAYMENT DISPUTES =============

model PaymentDispute {
  id     String @id @default(cuid())
  userId String

  // Payment info
  transactionId   String? // If they have it
  paymentMethod   String // "card" | "crypto"
  amount          Float
  transactionHash String? // Blockchain TX hash
  walletAddress   String? // Wallet they sent from
  paymentDate     DateTime
  cryptoCurrency  String? // "BTC", "ETH", "USDT", etc.

  // Contact
  email       String
  description String @db.Text

  // Resolution
  status       String    @default("PENDING") // "PENDING" | "INVESTIGATING" | "RESOLVED" | "REJECTED"
  resolution   String? // Admin notes
  creditAmount Int? // Credits given if resolved
  resolvedAt   DateTime?
  resolvedBy   String? // Admin user ID

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// DisputeStatus: "PENDING" | "INVESTIGATING" | "RESOLVED" | "REJECTED"

// ============= ANALYTICS =============

model PageView {
  id String @id @default(cuid())

  // Page info
  path     String
  referrer String?

  // Visitor info
  visitorId String // Anonymous visitor ID (from cookie)
  userId    String? // Logged in user ID (optional)

  // Device/Browser info
  userAgent String?
  device    String? // "desktop" | "mobile" | "tablet"
  browser   String?
  os        String?
  country   String?

  // Session
  sessionId String

  createdAt DateTime @default(now())

  @@index([path])
  @@index([visitorId])
  @@index([createdAt])
  @@index([sessionId])
}

model DailyStats {
  id   String   @id @default(cuid())
  date DateTime @unique

  // Visits
  totalViews     Int @default(0)
  uniqueVisitors Int @default(0)

  // Top pages (JSON)
  topPages String @default("[]")

  // Sources
  topReferrers String @default("[]")

  // Devices
  deviceStats String @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============= SITE SETTINGS =============

model SiteSettings {
  id          String  @id @default(cuid())
  creatorSlug String? @unique

  // Site settings
  siteName        String?
  siteDescription String?
  siteUrl         String?
  welcomeMessage  String?
  welcomeMediaId  String? // ID of MediaContent to send with welcome message
  welcomeMediaUrl String? // Direct URL if uploaded separately

  // Branding
  logo         String?
  favicon      String?
  primaryColor String?
  accentColor  String?

  // Pricing (stored as JSON string)
  pricing String @default("{}")

  // Payment toggles
  stripeEnabled Boolean @default(true)
  cryptoEnabled Boolean @default(false)

  // Features toggles
  chatEnabled Boolean @default(true)
  tipsEnabled Boolean @default(true)
  ppvEnabled  Boolean @default(true)

  // System toggles
  maintenanceMode     Boolean @default(false)
  registrationEnabled Boolean @default(true)
  emailNotifications  Boolean @default(true)
  pushNotifications   Boolean @default(false)

  // Platform commission settings
  platformWalletEth        String?
  platformWalletBtc        String?
  platformCommission       Float   @default(0.05) // 5% default
  firstMonthFreeCommission Boolean @default(true) // 0% first month

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============= ACCOUNTING QUEUE =============

model AccountingQueue {
  id String @id @default(cuid())

  // Payload data (JSON)
  payload String

  // Status
  status String @default("PENDING") // "PENDING" | "PROCESSING" | "COMPLETED" | "FAILED"

  // Retry info
  attempts    Int       @default(0)
  maxAttempts Int       @default(5)
  lastError   String?
  nextRetryAt DateTime?

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  processedAt DateTime?

  @@index([status])
  @@index([nextRetryAt])
}

// ============= MARKETPLACE: FIND MODEL / FIND AGENCY =============

model ModelListing {
  id        String  @id @default(cuid())
  creatorId String  @unique
  creator   Creator @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  // Profile
  bio         String?  @db.Text
  photos      String[] // Array of photo URLs (max 5)
  socialLinks String   @default("{}") // JSON: { instagram, twitter, tiktok, etc }
  tags        String[] // Content category tags

  // Terms
  revenueShare    Int     @default(70) // % creator keeps (70 = creator 70%, agency 30%)
  chattingEnabled Boolean @default(true) // Willing to do chatting

  // Stats (cached from reviews)
  averageRating Float @default(0)
  reviewCount   Int   @default(0)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  applications AgencyApplication[]

  @@index([isActive])
  @@index([revenueShare])
  @@index([averageRating])
}

model AgencyListing {
  id       String @id @default(cuid())
  agencyId String @unique
  agency   Agency @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  // What they're looking for
  headline     String? // "Looking for experienced creators"
  description  String? @db.Text // Detailed description
  lookingFor   String? @db.Text // JSON array: ["Female", "Male", "Couple"]
  contentTypes String? @db.Text // JSON array: ["Solo", "B/G", "Fetish"]
  requirements String? @db.Text // What they require from models

  // Terms offered
  minRevenueShare   Int     @default(50) // Min % creator keeps
  maxRevenueShare   Int     @default(70) // Max % creator keeps
  providesContent   Boolean @default(false) // Do they provide content/shoots
  providesChatting  Boolean @default(true) // Do they provide chatters
  providesMarketing Boolean @default(true) // Do they provide marketing

  // Location preferences
  location      String? // Agency location
  acceptsRemote Boolean @default(true)

  // Stats (cached from reviews)
  averageRating Float @default(0)
  reviewCount   Int   @default(0)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  applications AgencyApplication[]

  @@index([isActive])
  @@index([averageRating])
}

model AgencyApplication {
  id String @id @default(cuid())

  // Model listing (can be null if agency initiates)
  modelListingId String?
  modelListing   ModelListing? @relation(fields: [modelListingId], references: [id], onDelete: Cascade)

  // Agency listing (can be null if model initiates)
  agencyListingId String?
  agencyListing   AgencyListing? @relation(fields: [agencyListingId], references: [id], onDelete: Cascade)

  // Agency
  agencyId String
  agency   Agency @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  // Direction: who initiated the contact
  initiatedBy String // "MODEL" or "AGENCY"

  // Status
  status String @default("PENDING") // PENDING, ACCEPTED, REJECTED, IGNORED

  // Optional message with request
  message String? @db.Text

  // Conversation (if started after acceptance)
  conversationId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([modelListingId, agencyId])
  @@index([agencyId])
  @@index([status])
}

// ApplicationStatus: "PENDING" | "ACCEPTED" | "REJECTED" | "IGNORED"
// ApplicationInitiator: "MODEL" | "AGENCY"

model AgencyReview {
  id String @id @default(cuid())

  // Reviewer
  reviewerId   String // User ID of the reviewer
  reviewerType String // "MODEL" or "AGENCY"

  // Reviewed target
  targetId   String // Agency ID (if model reviews) or Creator ID (if agency reviews)
  targetType String // "AGENCY" or "MODEL"

  // Review content
  rating  Int // 1-5 stars
  comment String? @db.Text

  // Eligibility tracking - when collaboration started
  collaborationStartedAt DateTime

  createdAt DateTime @default(now())

  @@unique([reviewerId, targetId])
  @@index([targetId, targetType])
  @@index([rating])
}

// ============= AI SUGGESTIONS (for AI-assisted mode) =============

model AiSuggestion {
  id String @id @default(cuid())

  // Conversation
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // Link to message if sent
  messageId String?  @unique
  message   Message? @relation(fields: [messageId], references: [id], onDelete: SetNull)

  // Suggestion content
  content       String  @db.Text
  mediaDecision String? // "FREE" | "PPV" | "TEASE" | "NONE"
  mediaId       String?

  // AI Personality that generated this
  personalityId String
  personality   CreatorAiPersonality @relation(fields: [personalityId], references: [id], onDelete: Cascade)

  // Status
  status        String  @default("pending") // "pending" | "sent" | "edited" | "rejected" | "expired"
  editedContent String? @db.Text // If chatter edited before sending

  // Who sent it (if sent)
  sentById String?
  sentBy   Chatter? @relation("SentBySuggestions", fields: [sentById], references: [id], onDelete: SetNull)

  // Timing
  expiresAt DateTime // Suggestions expire after X minutes
  sentAt    DateTime?

  // Billing tracking
  chargedCredits Int       @default(0) // Credits charged for this suggestion
  chargedAt      DateTime? // When credits were charged

  createdAt DateTime @default(now())

  @@index([conversationId])
  @@index([personalityId])
  @@index([status])
  @@index([expiresAt])
}

// ============= FAN PROFILE (for AI memory) =============

model FanProfile {
  id String @id @default(cuid())

  // Fan identification
  fanUserId   String
  creatorSlug String

  // Detected preferences
  preferredTone   String? // "romantic", "playful", "explicit", etc.
  preferredTopics String[] @default([]) // ["fitness", "travel", "flirty"]
  spendingTier    String? // "whale", "regular", "free"
  activityLevel   String? // "daily", "weekly", "occasional"
  timezone        String?
  language        String?

  // Aggregated history
  totalSpent    Float     @default(0)
  totalMessages Int       @default(0)
  lastSeen      DateTime?
  firstSeen     DateTime  @default(now())

  // AI-generated notes/summary
  notes String? @db.Text

  // Personal note - rich summary of everything known about the fan
  // Auto-generated by AI from memories, or manually edited by chatter
  personalNote          String?   @db.Text
  personalNoteUpdatedAt DateTime?
  personalNoteUpdatedBy String?   // "ai" | chatterId

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Quality scoring (for pre-qualification)
  qualityScore            Int      @default(50) // 0-100
  qualityTier             String   @default("unknown") // "vip", "qualified", "unqualified", "unknown"
  messagesWithoutPurchase Int      @default(0)
  freeContentRequests     Int      @default(0)
  aiOnlyMode              Boolean  @default(false) // If true, never route to human
  aiOnlyReason            String?

  @@unique([fanUserId, creatorSlug])
  @@index([creatorSlug])
  @@index([spendingTier])
  @@index([activityLevel])
  @@index([qualityTier])
}

// ============= FAN PRESENCE (for auto-bump) =============

model FanPresence {
  id              String    @id @default(cuid())
  fanUserId       String
  creatorSlug     String

  // Online status
  isOnline        Boolean   @default(false)
  lastSeen        DateTime  @default(now())

  // Bump tracking
  lastBumpedAt      DateTime?
  bumpCooldownHours Int       @default(24)
  totalBumps        Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([fanUserId, creatorSlug])
  @@index([isOnline, lastBumpedAt])
  @@index([creatorSlug])
}

// ============= AUTO-BUMP QUEUE =============

model AutoBump {
  id             String   @id @default(cuid())
  conversationId String
  fanUserId      String
  creatorSlug    String

  // Scheduling
  scheduledAt DateTime
  status      String   @default("PENDING") // PENDING, SENT, CANCELLED, FAILED

  // Bump type
  bumpType String // "online_greeting", "dormant_reactivation", "new_content"

  // AI Personality to use
  personalityId String?

  // Generated message
  message String? @db.Text

  // Result
  sentAt    DateTime?
  messageId String? // Message created
  error     String?

  createdAt DateTime @default(now())

  @@index([status, scheduledAt])
  @@index([creatorSlug])
  @@index([fanUserId])
}

// BumpType: "online_greeting" | "dormant_reactivation" | "new_content"
// BumpStatus: "PENDING" | "SENT" | "CANCELLED" | "FAILED"

// ============= CONVERSATION HANDOFF =============

model ConversationHandoff {
  id             String @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // Trigger
  triggerType  String  // "spending_threshold", "high_intent", "quality_upgrade", "manual"
  triggerValue String? // e.g., "spent:45.00" or "keyword:buy now"

  // From AI to Human
  fromAiPersonalityId String?
  toChatterId         String?

  // Status
  status      String    @default("PENDING") // PENDING, ACCEPTED, DECLINED, EXPIRED, AUTO_ASSIGNED
  notifiedAt  DateTime?
  respondedAt DateTime?
  expiresAt   DateTime?

  // Notes
  notes String? @db.Text

  createdAt DateTime @default(now())

  @@index([conversationId])
  @@index([toChatterId, status])
  @@index([status])
}

// HandoffTrigger: "spending_threshold" | "high_intent" | "quality_upgrade" | "manual"
// HandoffStatus: "PENDING" | "ACCEPTED" | "DECLINED" | "EXPIRED" | "AUTO_ASSIGNED"

// ============= OBJECTION PATTERNS =============

model ObjectionPattern {
  id       String @id @default(cuid())
  agencyId String

  // Pattern definition
  name     String // "Too Expensive", "Maybe Later", etc.
  patterns String @db.Text // JSON array of regex/keyword patterns

  // Response strategy
  strategy         String  @default("urgency") // "discount_offer", "urgency", "value_prop", "scarcity", "social_proof"
  responseTemplate String  @db.Text // Template with variables

  // Discount settings (if strategy = discount_offer)
  discountEnabled    Boolean @default(false)
  discountPercent    Int?
  discountMaxAmount  Float?
  discountValidHours Int     @default(2)

  // Multi-language support
  language String @default("all") // "all", "en", "fr", "es", etc.

  // Priority (for multiple matches)
  priority Int     @default(0)
  isActive Boolean @default(true)

  // Stats
  timesTriggered Int   @default(0)
  timesConverted Int   @default(0)
  conversionRate Float @default(0)
  totalRevenue   Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  handlings ObjectionHandling[]

  @@index([agencyId])
  @@index([isActive])
  @@index([language])
}

// ObjectionStrategy: "discount_offer" | "urgency" | "value_prop" | "scarcity" | "social_proof"

// ============= OBJECTION HANDLING LOG =============

model ObjectionHandling {
  id             String @id @default(cuid())
  conversationId String
  messageId      String // Fan's objection message

  // Pattern matched
  patternId String
  pattern   ObjectionPattern @relation(fields: [patternId], references: [id], onDelete: Cascade)

  // Response
  responseMessageId String?
  strategy          String
  discountCodeId    String? // If discount was offered

  // Outcome
  outcome          String? // "converted", "declined", "no_response", "escalated"
  outcomeMessageId String? // The purchase message if converted
  revenueGenerated Float?

  createdAt  DateTime  @default(now())
  resolvedAt DateTime?

  @@index([conversationId])
  @@index([patternId])
  @@index([outcome])
}

// ObjectionOutcome: "converted" | "declined" | "no_response" | "escalated"

// ============= DISCOUNT CODES =============

model DiscountCode {
  id          String @id @default(cuid())
  code        String @unique
  creatorSlug String

  // Discount details
  discountType   String // "percent", "fixed"
  discountValue  Float // 20 for 20% or 5 for $5
  maxDiscount    Float? // Max discount in credits (for percent)
  minPurchase    Float? // Min purchase required

  // Validity
  expiresAt    DateTime?
  maxUses      Int?
  currentUses  Int       @default(0)
  isActive     Boolean   @default(true)

  // Targeting
  fanUserId      String? // If specific to a fan
  conversationId String? // If specific to a conversation

  // Source
  sourceType String? // "objection", "flash_sale", "retargeting", "manual"
  sourceId   String? // ObjectionHandling ID, FlashSale ID, etc.

  createdAt DateTime @default(now())
  usedAt    DateTime?

  @@index([code])
  @@index([creatorSlug])
  @@index([fanUserId])
  @@index([isActive, expiresAt])
}

// DiscountType: "percent" | "fixed"
// DiscountSource: "objection" | "flash_sale" | "retargeting" | "manual"

// ============= FAN LEAD SCORE =============

model FanLeadScore {
  id          String @id @default(cuid())
  fanUserId   String
  creatorSlug String

  // Overall score (0-100)
  score Int @default(50)

  // Component scores (0-100 each)
  engagementScore Int @default(50) // Message frequency, responses
  spendingScore   Int @default(50) // Historical + recent spending
  intentScore     Int @default(50) // Purchase intent signals
  recencyScore    Int @default(50) // How recent is activity

  // Predictions
  predictedLTV        Float? // Predicted lifetime value in EUR
  purchaseProbability Float? // 0-1 probability of next purchase
  churnRisk           Float? // 0-1 probability of churning

  // Scoring factors (JSON for transparency)
  factors String? @db.Text

  // Metadata
  lastCalculated DateTime @default(now())
  version        Int      @default(1) // Scoring algorithm version

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([fanUserId, creatorSlug])
  @@index([creatorSlug, score])
  @@index([score])
}

// ============= BUNDLES =============

model Bundle {
  id       String @id @default(cuid())
  agencyId String

  // Bundle info
  name        String
  description String? @db.Text
  coverImage  String?

  // Contents (JSON array of media IDs)
  mediaIds String @db.Text

  // Pricing
  originalPrice   Float // Sum of individual prices
  bundlePrice     Float // Discounted bundle price
  discountPercent Int // For display

  // Availability
  availableFor String? // "all", "whales", "new_fans", "dormant", "qualified"
  creatorSlug  String? // If specific to a creator

  // Limits
  maxPurchases Int? // Max total purchases
  purchaseCount Int @default(0)

  // Status
  isActive  Boolean   @default(true)
  startsAt  DateTime?
  endsAt    DateTime?

  // Stats
  totalRevenue Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  flashSales FlashSale[]

  @@index([agencyId])
  @@index([creatorSlug])
  @@index([isActive])
}

// BundleAvailability: "all" | "whales" | "new_fans" | "dormant" | "qualified"

// ============= FLASH SALES =============

model FlashSale {
  id             String @id @default(cuid())
  conversationId String
  fanUserId      String
  creatorSlug    String

  // What's on sale
  bundleId String?
  bundle   Bundle? @relation(fields: [bundleId], references: [id], onDelete: SetNull)
  mediaId  String? // Single media if not a bundle

  // Offer details
  originalPrice Float
  salePrice     Float
  discountCode  String @unique

  // Urgency
  expiresAt    DateTime
  reminderSent Boolean  @default(false)

  // Status
  status     String    @default("ACTIVE") // ACTIVE, REDEEMED, EXPIRED, CANCELLED
  redeemedAt DateTime?

  // Trigger
  triggerType String? // "ai_detected", "chatter_manual", "scheduled"

  createdAt DateTime @default(now())

  @@index([fanUserId])
  @@index([creatorSlug])
  @@index([status, expiresAt])
  @@index([discountCode])
}

// FlashSaleStatus: "ACTIVE" | "REDEEMED" | "EXPIRED" | "CANCELLED"
// FlashSaleTrigger: "ai_detected" | "chatter_manual" | "scheduled"

// ============= FAN MEMORY (conversational memory) =============

model FanMemory {
  id          String @id @default(cuid())
  fanUserId   String
  creatorSlug String

  // Memory content
  category String // "personal", "preference", "event", "purchase", "relationship"
  key      String // "name", "birthday", "job", "favorite_type", "mentioned_breakup"
  value    String @db.Text

  // Confidence and source
  confidence      Float   @default(0.8) // 0-1 how confident
  sourceMessageId String? // Message where this was extracted
  extractedBy     String  @default("ai") // "ai" or "chatter"

  // Validity
  lastConfirmed DateTime?
  expiresAt     DateTime? // Some memories expire (e.g., "is traveling")
  isActive      Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([fanUserId, creatorSlug, key])
  @@index([fanUserId, creatorSlug])
  @@index([category])
  @@index([isActive])
}

// MemoryCategory: "personal" | "preference" | "event" | "purchase" | "relationship"

// ============= RETARGETING CAMPAIGNS =============

model RetargetingCampaign {
  id          String @id @default(cuid())
  fanUserId   String
  creatorSlug String

  // Trigger
  triggerType String // "dormant_7d", "dormant_30d", "new_content", "birthday", "anniversary"
  triggeredAt DateTime @default(now())

  // Content
  channel     String // "email", "push", "in_app"
  templateId  String?
  subject     String?
  content     String  @db.Text
  mediaId     String? // Attached media teaser

  // Offer (optional)
  discountCodeId String?
  flashSaleId    String?

  // Status
  status      String    @default("PENDING") // PENDING, SENT, OPENED, CLICKED, CONVERTED, FAILED
  sentAt      DateTime?
  openedAt    DateTime?
  clickedAt   DateTime?
  convertedAt DateTime?
  error       String?

  // Revenue attribution
  revenueGenerated Float?

  createdAt DateTime @default(now())

  @@index([fanUserId])
  @@index([creatorSlug])
  @@index([status])
  @@index([triggerType])
}

// RetargetingTrigger: "dormant_7d" | "dormant_30d" | "new_content" | "birthday" | "anniversary"
// RetargetingChannel: "email" | "push" | "in_app"
// RetargetingStatus: "PENDING" | "SENT" | "OPENED" | "CLICKED" | "CONVERTED" | "FAILED"

// ============= AI PERFORMANCE TRACKING =============

model AiPerformanceSummary {
  id          String   @id @default(cuid())
  creatorSlug String
  date        DateTime @db.Date

  // AI metrics
  aiMessages        Int   @default(0)
  aiRevenue         Float @default(0)
  aiConversions     Int   @default(0)
  aiAvgResponseTime Float @default(0)

  // Chatter metrics
  chatterMessages        Int   @default(0)
  chatterRevenue         Float @default(0)
  chatterConversions     Int   @default(0)
  chatterAvgResponseTime Float @default(0)

  // Comparison
  aiRevenuePerMessage      Float @default(0)
  chatterRevenuePerMessage Float @default(0)
  aiConversionRate         Float @default(0)
  chatterConversionRate    Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([creatorSlug, date])
  @@index([creatorSlug])
  @@index([date])
}

// ============= TRANSPARENT STATS - AGENCIES =============

model AgencyPublicStats {
  id       String @id @default(cuid())
  agencyId String @unique
  agency   Agency @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  // Snapshot timestamp
  calculatedAt DateTime @default(now())

  // Creator metrics
  activeCreators    Int @default(0) // Currently active creators
  totalCreatorsEver Int @default(0) // Total creators ever managed

  // Revenue metrics (aggregated from all creators, last 30 days)
  totalRevenueLast30d  Float @default(0)
  avgRevenuePerCreator Float @default(0)
  revenueGrowth3m      Float @default(0) // % growth over 3 months

  // Payout reliability
  payoutSuccessRate  Float @default(100) // % payouts on time
  avgPayoutDelayDays Float @default(0) // Average days to pay

  // Commission rates
  avgCommissionRate Float @default(0)
  minCommissionRate Float @default(0)
  maxCommissionRate Float @default(0)

  // Retention metrics
  avgCollaborationMonths Float @default(0) // Average collaboration duration
  retention6m            Float @default(0) // % creators still active after 6 months
  retention12m           Float @default(0) // % creators still active after 12 months

  // Responsiveness
  avgResponseTimeHours Float @default(0)

  // Monthly history for charts (JSON)
  monthlyHistory String? @db.Text // [{month, revenue, creators, growth}]

  // Earned badges (JSON array of badge IDs)
  badges String @default("[]")

  // Aggregated review data
  avgRating    Float @default(0)
  totalReviews Int   @default(0)

  // Visibility control
  isPublic Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([avgRating])
  @@index([activeCreators])
}

// ============= TRANSPARENT STATS - CREATORS =============

model CreatorPublicStats {
  id        String  @id @default(cuid())
  creatorId String  @unique
  creator   Creator @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  // Snapshot timestamp
  calculatedAt DateTime @default(now())

  // Revenue metrics
  revenueLast30d     Float @default(0)
  revenueAvg3m       Float @default(0)
  revenueTrend       Float @default(0) // % vs previous month
  totalRevenueAllTime Float @default(0)

  // Revenue breakdown
  revenueFromSubs     Float @default(0)
  revenueFromPPV      Float @default(0)
  revenueFromTips     Float @default(0)
  revenueFromMessages Float @default(0)

  // Subscriber metrics
  activeSubscribers     Int   @default(0)
  subscriberRetention   Float @default(0) // % who renew
  avgSubscriptionMonths Float @default(0)
  subscriberGrowth30d   Float @default(0) // % growth

  // Activity metrics
  activityRate       Float     @default(0) // % days active last 30
  avgResponseMinutes Float     @default(0)
  lastActiveAt       DateTime?

  // Conversion metrics
  messageToSaleRate Float @default(0) // % messages resulting in sale
  ppvUnlockRate     Float @default(0) // % PPV unlocked

  // Content metrics
  totalPosts      Int   @default(0)
  postsLast30d    Int   @default(0)
  avgPostsPerWeek Float @default(0)
  totalMedia      Int   @default(0)

  // Engagement metrics
  avgLikesPerPost    Float @default(0)
  avgCommentsPerPost Float @default(0)

  // Monthly history for charts
  monthlyHistory String? @db.Text // [{month, revenue, subscribers, posts}]

  // Badges
  badges String @default("[]")

  // Aggregated review data
  avgRating    Float @default(0)
  totalReviews Int   @default(0)

  // Visibility controls (creator can hide certain stats)
  showRevenue     Boolean @default(true)
  showSubscribers Boolean @default(true)
  showActivity    Boolean @default(true)
  isPublic        Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([avgRating])
  @@index([revenueLast30d])
  @@index([activeSubscribers])
}

// ============= STATS SNAPSHOTS (for historical charts) =============

model StatsSnapshot {
  id         String   @id @default(cuid())
  entityType String // "AGENCY" | "CREATOR"
  entityId   String
  snapshotAt DateTime @default(now())

  // All metrics at this point in time (JSON)
  metrics String @db.Text

  @@index([entityType, entityId])
  @@index([snapshotAt])
}

// StatsEntityType: "AGENCY" | "CREATOR"

// ============= VERIFIED REVIEWS =============

model VerifiedReview {
  id String @id @default(cuid())

  // Who is reviewing
  reviewerType String // "CREATOR" | "AGENCY"
  reviewerId   String

  // Who is being reviewed
  targetType String // "AGENCY" | "CREATOR"
  targetId   String

  // Review content
  rating  Int     @default(5) // 1-5 stars
  title   String?
  content String? @db.Text

  // Detailed ratings (1-5 each, optional)
  communicationRating     Int? // How well they communicate
  professionalismRating   Int? // How professional they are
  paymentReliabilityRating Int? // For agencies: do they pay on time
  contentQualityRating    Int? // For creators: quality of content
  supportRating           Int? // Quality of support provided

  // Verification
  isVerified      Boolean @default(false) // True if collaboration verified
  collaborationId String? // Link to the collaboration record

  // Moderation
  isPublished Boolean @default(true)
  reportCount Int     @default(0)
  isHidden    Boolean @default(false) // Admin can hide

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([reviewerId, targetId]) // One review per relationship
  @@index([targetType, targetId])
  @@index([reviewerType, reviewerId])
  @@index([rating])
  @@index([isPublished])
}

// ReviewerType: "CREATOR" | "AGENCY"
// TargetType: "AGENCY" | "CREATOR"


// ============= DMCA NOTICES =============

model DMCANotice {
  id String @id @default(cuid())

  // Complainant info
  name    String
  email   String
  company String?

  // Content info
  contentUrl  String // URL of infringing content on VipOnly
  originalUrl String // URL of original work

  // Description
  description String @db.Text
  signature   String // Electronic signature

  // Status
  status     String    @default("PENDING") // PENDING, INVESTIGATING, ACTIONED, REJECTED, COUNTER_NOTICE
  resolution String?   @db.Text
  resolvedAt DateTime?
  resolvedBy String?

  // Counter-notice
  counterNotice   Boolean   @default(false)
  counterNoticeAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([email])
  @@index([createdAt])
}

// DMCAStatus: "PENDING" | "INVESTIGATING" | "ACTIONED" | "REJECTED" | "COUNTER_NOTICE"

// ============= CREATOR VERIFICATION (KYC) =============

model CreatorVerification {
  id String @id @default(cuid())

  // Creator being verified
  creatorId   String  @unique
  creatorSlug String

  // Document info
  documentType String // PASSPORT, ID_CARD, DRIVERS_LICENSE
  documentFrontUrl String // Uploaded document front
  documentBackUrl String? // Uploaded document back (if applicable)
  selfieUrl String // Selfie holding document

  // Extracted info
  fullName    String?
  dateOfBirth DateTime?
  nationality String?
  documentNumber String?
  documentExpiry DateTime?

  // Verification status
  status         String    @default("PENDING") // PENDING, APPROVED, REJECTED, EXPIRED
  verifiedAt     DateTime?
  verifiedBy     String?   // Admin who verified
  rejectionReason String?

  // Auto-verification (if using service)
  externalId     String?  // ID from verification service (e.g., Jumio, Veriff)
  externalStatus String?  // Status from service
  confidenceScore Float?  // 0-1 confidence score

  // Document expiry tracking
  expiresAt DateTime? // When the ID document expires
  reminderSent Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([creatorSlug])
  @@index([expiresAt])
}

// VerificationDocumentType: "PASSPORT" | "ID_CARD" | "DRIVERS_LICENSE"
// VerificationStatus: "PENDING" | "APPROVED" | "REJECTED" | "EXPIRED"

// ============= CREATOR APPLICATION (Become a Creator) =============

model CreatorApplication {
  id String @id @default(cuid())

  // User applying to become a creator
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Desired creator profile info
  displayName String
  slug        String? // Desired slug (optional, can be auto-generated)
  bio         String? @db.Text

  // Identity verification document
  documentUrl  String // Photo of ID document (required)
  documentType String @default("ID_CARD") // ID_CARD, PASSPORT, DRIVERS_LICENSE

  // Application status
  status          String    @default("PENDING") // PENDING, APPROVED, REJECTED
  reviewedAt      DateTime?
  reviewedBy      String? // Admin user ID who reviewed
  rejectionReason String?

  // Created creator (set after approval)
  createdCreatorId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, status]) // One pending application per user
  @@index([status])
  @@index([createdAt])
}

// CreatorApplicationStatus: "PENDING" | "APPROVED" | "REJECTED"

// ============= PAYOUT REQUESTS =============

model PayoutRequest {
  id          String   @id @default(cuid())
  creatorSlug String
  creator     Creator  @relation(fields: [creatorSlug], references: [slug], onDelete: Cascade)

  // Amount requested (creator's pending balance at time of request)
  amount      Float

  // Wallet info
  walletType    String  // "ETH" | "BTC"
  walletAddress String

  // Business info
  businessNumber String? // Business registration number

  // Status
  status      String    @default("PENDING") // "PENDING" | "PAID"
  paidAt      DateTime?
  paidBy      String?   // Admin user ID who processed the payout
  txHash      String?   // Blockchain transaction hash (optional)

  createdAt   DateTime @default(now())

  @@index([creatorSlug])
  @@index([status])
  @@index([createdAt])
}

// ============= AGENCY PAYOUT REQUESTS =============

model AgencyPayoutRequest {
  id       String @id @default(cuid())
  agencyId String

  agency Agency @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  // Amount requested
  amount Float

  // Wallet info
  walletType    String // "ETH" | "BTC"
  walletAddress String

  // Status
  status String    @default("PENDING") // "PENDING" | "PAID"
  paidAt DateTime?
  paidBy String? // Admin user ID
  txHash String? // Blockchain transaction hash

  createdAt DateTime @default(now())

  @@index([agencyId])
  @@index([status])
  @@index([createdAt])
}

// ============= CHATTER PAYOUT REQUESTS =============

model ChatterPayoutRequest {
  id        String @id @default(cuid())
  chatterId String
  agencyId  String // Agency that processed the payout

  chatter Chatter @relation(fields: [chatterId], references: [id], onDelete: Cascade)

  // Amount paid
  amount Float

  // Wallet info
  walletType    String // "ETH" | "BTC"
  walletAddress String

  // Status
  status String    @default("PENDING") // "PENDING" | "PAID"
  paidAt DateTime?
  paidBy String? // Agency owner who processed
  txHash String?

  createdAt DateTime @default(now())

  @@index([chatterId])
  @@index([agencyId])
  @@index([status])
  @@index([createdAt])
}

// ============= AGENCY -> CREATOR PAYOUT =============

model AgencyCreatorPayout {
  id          String @id @default(cuid())
  agencyId    String
  creatorSlug String

  agency Agency @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  // Amount paid
  amount Float

  // Wallet info (copied from creator at time of payout)
  walletType    String
  walletAddress String

  // Status
  status String    @default("PENDING") // "PENDING" | "PAID"
  paidAt DateTime?
  paidBy String? // Agency owner who processed
  txHash String?

  createdAt DateTime @default(now())

  @@index([agencyId])
  @@index([creatorSlug])
  @@index([status])
  @@index([createdAt])
}

// PayoutStatus: "PENDING" | "PAID"

