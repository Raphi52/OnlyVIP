import { PrismaClient } from "@prisma/client";
import * as fs from "fs";
import * as path from "path";

const prisma = new PrismaClient();

// File prefixes for esmeralda (from juliethofl folder)
const ESMERALDA_PREFIXES = new Set([
  "3097736382105339384","3098541333274861187","3115007734125662429","3123657913142385744","3139060541796007962","3139541835571534143","3139899248698875066","3164516572936470237","3168900648296503802","3168909825282639696","3178107729699628603","3197083076466765087","3239128163966721306","3239638918365873222","3239639490821200551","3239699195606130172","3239703286755470230","3240304546264720498","3240706507841672578","3240709070594992576","3253435569719125671","3253456724991446221","3254346109555041554","3307212755130596602","3310688638969936392","3344704195461316712","3345626504338460437","3351466962549297749","3386052445187232327","3415106358403054445","3418818524581564209","3432418676517344762","3437473173875635872","3452752882897153693","3453432506249427661","3454163007968932284","3457774159059882381","3468659326842534290","3469346783694991482","3471558908027061691","3471788560456724463","3472241974475008202","3473792177090632377","3474447116997621845","3476146901693722376","3476619707626774943","3477353218395463913","3478091413902980913","3478800256203005358","3479548581533711603","3481074118134550851","3481465367064699014","3487666587459572958","3488223021062595859","3488395836290013338","3489130291338384590","3492568224359598154","3492760966842941016","3493292767667671421","3499290053814375466","3499848429922972183","3500028162325558599","3500564315961221016","3501454658143418766","3502222124800972049","3502722059187014078","3504184766478347809","3504386130735160611","3504902735659494217","3506322847771846736","3507266099664500714","3508499126944092402","3509230736177973851","3510872328571828324","3513584815956199767","3515053574940104134","3515220367621206647","3515784466562240145","3515957258448357205","3516479269897614488","3517953347200477810","3520123827076447176","3525224128842190248","3525914197865301948","3527573271279374068","3528816526553872030","3530268910949777798","3532006509712498095","3532455426119757344","3533883179918640543","3536792375252142203","3541164180217571129","3541324258926308656","3541865515704610442","3546289777374697319","3546404504218284108","3547152642734489236","3547648953493529546","3557298994990688900","3560888589372121983","3561435063235451802","3561618386457127682","3572313398555703676","3581733903746385547","3582655336752116537","3588268509454681997","3600776913687589407","3601537139038640613","3609340495882644143","3644773959154985732","3654176205651069213","3662113110128828566","3672595525003122314","3677398623534292319","3677596564148615529","3678311648587954943","3678833468516969232","3679574998764528329","3680292326561231112","3683375356643422504","3687737103200224006","3731033203487160685","3757109147842157788","3758568581689383776","3759468595869564961","3769442135209307822","3770895639685802331","3771065317964023608","3771771701160505471","3772349077187630244","3772516034419511376"
]);

// File prefixes for bold-kira (from spirite_moon folder)
const BOLDKIRA_PREFIXES = new Set([
  "2774261741962451509","2774357678621921822","2774357995442750569","2826406752384210368","2831675277306870880","2860964575054957720","2864249651784311132","2864341165633916340","2867188802535961091","2875190315166394299","2875924544674196860","2876975593451321263","2885417002395170714","2887214336250620023","2893314745956539134","2893887784385507106","2896484223289040937","2900950834817774111","2900994144924215883","2901248971558054290","2901941556190417574","2909265800251400106","2911024797010662899","2918380576575168910","2928116952971257604","2929534189184176495","2930621218512726427","2942610706625357733","2943779257595899496","2945120709286590769","2945239107056062119","2948268231022562401","2949804165157413994","2956704438769481085","2958883781176279236","2960818177193810790","2962804662878571373","2963337798786608572","2964876312258819317","2965554238101037153","2966264526999660649","2968783980568602504","2969474896094593477","2970695776040742544","2983998847831456357","2984711798645208393","2991027148731311347","2991692118460218399","2995507224957105902","2999771432133331874","3002690678597333497","3006108193067264925","3006990601656726103","3010068122245516746","3020031310009526406","3025747004672024198","3025987694060532700","3027073008597924662","3031024883504907572","3032348707055929753","3033758062305277145","3039645286460671984","3039732991127892714","3040535059861537686","3041113384539776259","3052087776828258749","3055715724731007337","3060575063429982822","3072300659039140548","3083780613009504215","3085326928509174659","3094586967923984431","3101183341293727140","3109104333999461244","3116835049713553931","3116905617007868963","3117989498922552325","3121424215751404413","3125112150137177186","3135784070377493999","3142516406390021066","3143039254661584403","3146112128967679781","3153216380030859683","3159132371742631426","3167028753178758749","3169395800294462438","3176630707442034613","3180291319543953695","3184725958085686964","3188788826733025666","3188868960353828542","3190391265089677903","3201046416812728251","3203308524027804967","3211880641887912871","3217685314490265049","3254854757129284123","3258970410891331255","3261363059719837933","3268638224216254435","3293402021082604880","3299634585126228816","3301131478738080760","3301196007803072046","3304954103878955859","3309868671711111001","3312227054110128491","3320942037706985826","3337585035047683215","3338773687217880213","3338866558377811970","3341926435679650801","3343372404877152531","3343764784994073419","3348723097188120611","3353536881411163439","3361805286024773659","3396925147654625638","3411495327902593001","3415036310007064973","3430749092509766048","3435333019463772365","3438082442929226988","3439182060873713529","3439474720700309669","3440105529022987640","3440321153326874253","3440969191523232568","3442488222981917484","3443029302995581234","3446585125809862010","3446719213363509146","3447376646775553869","3448074855537556635","3448749461857093958","3449665997039378799","3449794825045265122","3450382686056318459","3451083422285156457","3451769197850979589","3453211804258965219","3454109291937386983","3456762324655497762","3458967008942263546","3459686463565232380","3461074601399506205","3464116866120354524","3465514182693849820","3466403518159002250","3469270096097982327","3469354809277306016","3471392087587759010","3471938563246312119","3474055048253545207","3475642782097071533","3478645882923546297","3484238105862324836","3487114174847968021","3488201768570628450","3489565887601505988","3492978426598926931","3494680465981302287","3496181892104342949","3496804820722475977","3498868825024543807","3498982818079057372","3499782100000507973","3500921574742665381","3502468956382930100","3503182560627395391","3503864214257839425","3504856122019057367","3508456161035180651","3509867350562817747","3514192965671765287","3518591804109254364","3523676895584168453","3526237109847801213","3528573164535905492","3529215388999141097","3530016051601474886","3530886082480666454","3531670532412108174","3537917949276900230","3543155462899875962","3544523419848637461","3548784480902877851","3550948138677503420","3556155910447672993","3557585154300387354","3560658722697835041","3564691068326868318","3566467336005236263","3567022810772529562","3567079694896273117","3567521020678970579","3570723897519150451","3571239231349608685","3572975212423909757","3584535520108037681","3585776167087438310","3587169293811205469","3588857905543941180","3590256982324380175","3591854054924266945","3596171254422057668","3596593625104730832","3601592492695128984","3602380567778619159","3604626255240156255","3606163762141143533","3612027421295714955","3613591812273101471","3614717728652430035","3615009373566344939","3615649956823777822","3616502583815948600","3617851421854993686","3622958280036561641","3624444820386279242","3626598191931200275","3630110034410808605","3633831960006239782","3639401338993814655","3642530500180879482","3643940276873857802","3646527748304753659","3650361402877532888","3651230776282752419","3653376862338333042","3654593618075664496","3657118932362312971","3658412025170562505","3661228404852442411","3663366676718380353","3666916298267169599","3669281789117022236","3672658538318843757","3680148174512648641","3680239722604690523","3682102124294932498","3682905444500522297","3684564311143673558","3685683165727106690","3687924119087394891","3689542161068249474","3692512996573914001","3693797302952877948","3701173649083086246","3701307097508577101","3708569299595606160","3709802552045914286","3713613248467275936","3714103690111702312","3724378653519499332","3733207072796868083","3733237650204152125","3733953665451967751","3735385169713448229","3737841427906000884","3738990679768149417","3745454137422322744","3754626463095320844","3756310163046496069","3757087181115730983","3759659553798695970","3761165912636980478","3762150951180879200","3762637298337338047","3762812128186274357","3763527242480838412","3765644745973665393","3770053436512646667"
]);

async function seedMedia() {
  console.log("üé¨ Starting media seed...\n");

  const mediaDir = path.join(process.cwd(), "public/uploads/media");

  // Read all files from media directory
  let allFiles: string[];
  try {
    allFiles = fs.readdirSync(mediaDir).filter(f =>
      f.endsWith(".jpg") || f.endsWith(".mp4") || f.endsWith(".png")
    );
  } catch (e) {
    console.error("Error reading media directory:", e);
    return;
  }

  // Filter files for each creator
  const esmeraldaFiles = allFiles.filter(f => {
    const prefix = f.split("_")[0];
    return ESMERALDA_PREFIXES.has(prefix);
  });

  const boldKiraFiles = allFiles.filter(f => {
    const prefix = f.split("_")[0];
    return BOLDKIRA_PREFIXES.has(prefix);
  });

  console.log(`Found ${esmeraldaFiles.length} files for esmeralda`);
  console.log(`Found ${boldKiraFiles.length} files for bold-kira\n`);

  // Seed media for each creator
  await seedCreatorMedia("esmeralda", esmeraldaFiles);
  await seedCreatorMedia("bold-kira", boldKiraFiles);

  console.log("\n‚úÖ Media seed complete!");
}

async function seedCreatorMedia(creatorSlug: string, files: string[]) {
  console.log(`\nüì∏ Seeding media for ${creatorSlug}...`);

  // Check if creator exists
  const creator = await prisma.creator.findUnique({
    where: { slug: creatorSlug },
  });

  if (!creator) {
    console.log(`‚ùå Creator ${creatorSlug} not found, skipping...`);
    return;
  }

  // Group files by post (same prefix before _1, _2, etc.)
  const posts = new Map<string, string[]>();

  for (const file of files) {
    const match = file.match(/^(.+?)_\d+\.(jpg|mp4|png)$/);
    if (match) {
      const postId = match[1];
      if (!posts.has(postId)) {
        posts.set(postId, []);
      }
      posts.get(postId)!.push(file);
    }
  }

  console.log(`Found ${posts.size} posts for ${creatorSlug}`);

  let created = 0;
  let skipped = 0;

  for (const [postId, postFiles] of posts) {
    // Sort files by number
    postFiles.sort((a, b) => {
      const numA = parseInt(a.match(/_(\d+)\./)?.[1] || "0");
      const numB = parseInt(b.match(/_(\d+)\./)?.[1] || "0");
      return numA - numB;
    });

    // First file is the main one
    const mainFile = postFiles[0];
    const isVideo = mainFile.endsWith(".mp4");
    const type = isVideo ? "VIDEO" : "IMAGE";
    const url = `/uploads/media/${mainFile}`;

    // Check if already exists
    const existing = await prisma.mediaContent.findFirst({
      where: { contentUrl: url, creatorSlug },
    });

    if (existing) {
      skipped++;
      continue;
    }

    // Random settings for variety
    const isPublic = Math.random() > 0.3; // 70% public
    const isPremium = !isPublic || Math.random() > 0.7;
    const price = isPremium ? Math.floor(Math.random() * 15) + 5 : null;

    // Create media entry
    await prisma.mediaContent.create({
      data: {
        creatorSlug,
        type,
        url,
        thumbnailUrl: isVideo ? url.replace(".mp4", "_thumb.jpg") : url,
        title: "",
        description: "",
        isPublic,
        isPremium,
        price,
        viewCount: Math.floor(Math.random() * 500),
        likeCount: Math.floor(Math.random() * 100),
      },
    });
    created++;
  }

  console.log(`‚úÖ ${creatorSlug}: Created ${created} media, skipped ${skipped} existing`);
}

seedMedia()
  .catch((e) => {
    console.error(e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
